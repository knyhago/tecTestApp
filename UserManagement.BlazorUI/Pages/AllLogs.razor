@page "/allLogs"
@using UserManagement.Data.Entities
@inject HttpClient Http

<h3>All Logs</h3>

<div class="d-flex justify-content-start gap-2 mb-3">
   <a type="button" class="btn btn-secondary" href="/userList">Back</a>
</div>

@if (logs is null)
{
    <p><em>Loading...</em></p>
}
else if (!logs.Any())
{
    <p><em>No logs found.</em></p>
}
else
{
    <!-- 🔍 Filters -->
    <div class="row mb-3">
        <div class="col-md-3">
            <input type="text" class="form-control" placeholder="Filter by Action"
                   @bind="filterAction" @bind:event="oninput" />
        </div>
        <div class="col-md-3">
            <input type="text" class="form-control" placeholder="Filter by Performed By"
                   @bind="filterPerformedBy" @bind:event="oninput" />
        </div>
        <div class="col-md-3 d-flex gap-2">
            <button class="btn btn-primary" @onclick="ApplyFilter">Filter</button>
            <button class="btn btn-outline-secondary" @onclick="ClearFilter">Clear</button>
        </div>
    </div>

    <table class="table table-striped table-bordered">
        <thead>
            <tr>
                <th>Action</th>
                <th>Details</th>
                <th>Performed By</th>
                <th>Timestamp</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var log in PagedLogs)
            {
                <tr>
                    <td>@log.Action</td>
                    <td>@log.Details</td>
                    <td>@log.PerformedBy</td>
                    <td>@log.Timestamp</td>
                    <td>
                        <a class="btn btn-primary" href="@($"/viewLogs/{log.UserId}")">Details</a>
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <!-- Pagination -->
    <nav>
        <ul class="pagination">
            <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                <button class="page-link" @onclick="() => GoToPage(currentPage - 1)">Previous</button>
            </li>
            <li class="page-item disabled">
                <span class="page-link">Page @currentPage of @TotalPages</span>
            </li>
            <li class="page-item @(currentPage == TotalPages ? "disabled" : "")">
                <button class="page-link" @onclick="() => GoToPage(currentPage + 1)">Next</button>
            </li>
        </ul>
    </nav>
}

@code {
    private List<Log>? logs;
    private List<Log> filteredLogs = new();

    private int currentPage = 1;
    private int pageSize = 10;

    private string? filterAction;
    private string? filterPerformedBy;

    private IEnumerable<Log> PagedLogs =>
        filteredLogs
            .OrderByDescending(l => l.Timestamp)
            .Skip((currentPage - 1) * pageSize)
            .Take(pageSize);

    private int TotalPages =>
        filteredLogs.Count == 0
            ? 1
            : (int)Math.Ceiling((double)filteredLogs.Count / pageSize);

    private void GoToPage(int page)
    {
        if (page < 1 || page > TotalPages) return;
        currentPage = page;
    }

    protected override async Task OnInitializedAsync()
    {
        logs = await Http.GetFromJsonAsync<List<Log>>("/api/logs");
        filteredLogs = logs ?? new List<Log>();
    }

    private void ApplyFilter()
    {
        if (logs == null) return;

        filteredLogs = logs
            .Where(l =>
                (string.IsNullOrEmpty(filterAction) || (l.Action?.Contains(filterAction, StringComparison.OrdinalIgnoreCase) ?? false)) &&
                (string.IsNullOrEmpty(filterPerformedBy) || (l.PerformedBy?.Contains(filterPerformedBy, StringComparison.OrdinalIgnoreCase) ?? false))
            ).ToList();

        currentPage = 1; // reset to first page
    }

    private void ClearFilter()
    {
        filterAction = null;
        filterPerformedBy = null;
        filteredLogs = logs?.ToList() ?? new List<Log>();
        currentPage = 1;
    }
}
